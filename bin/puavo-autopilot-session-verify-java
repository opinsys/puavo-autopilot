#!/bin/sh
#
# puavo-autopilot-session-verify-java - verify Java is working properly
#
# Copyright (C) 2015 Opinsys Oy
#
# This program is free software; you can redistribute it and/or modify it under
# the terms of the GNU General Public License as published by the Free Software
# Foundation; either version 2 of the License, or (at your option) any later
# version.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
# details.
#
# You should have received a copy of the GNU General Public License along with
# this program; if not, write to the Free Software Foundation, Inc., 51 Franklin
# Street, Fifth Floor, Boston, MA 02110-1301 USA.

set -eu

. puavo-autopilot-env

## Ensure Firefox is visible to before searching images from the page.
firefox 'https://www.java.com/en/download/installed.jsp?detect=jre' &
timeout 10 xdotool search --sync --classname Navigator
wmctrl -a firefox

## The verification page requires activation of the Java plugin
xy=$(pnggrep --center --try-times 10 "${PUAVO_AUTOPILOT_SHAREDIR}/activate-button.png")
xdotool mousemove $(echo "${xy}" | head -n1) click 1

## Firefox asks yet another confirmation before activating the Java plugin.
xdotool sleep 2 key Tab Tab Tab Return

## Java itself asks user to allow the verification applet to run.
xy=$(pnggrep --try-times 10 "${PUAVO_AUTOPILOT_SHAREDIR}/run-button.png")
xdotool mousemove $(echo "${xy}" | head -n1) click 1

pnggrep --try-times 20 "${PUAVO_AUTOPILOT_SHAREDIR}/success.png"
